import disnake
from disnake.ext import commands
import random

class History(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.questions = [
            "Кто главный герой? (Введите имя в именительном падеже, например: +Иван):",
            "Где всё происходит? (Введите место в предложном падеже с предлогом 'в/на', например: +в парке):", 
            "Когда это было? (Введите время в предложном падеже, например: +тёплым утром):",
            "Какая была погода? (Введите в именительном падеже, например: +солнечная погода):",
            "Какое событие произошло? (Введите в прошедшем времени, например: +произошла неожиданная встреча):",
            "Кого встретил герой? (Введите в винительном падеже, например: +старого друга):",
            "Что сделал герой после встречи? (Введите в прошедшем времени, например: +отправился на прогулку):",
            "Куда направились герои? (Введите в винительный падеже с предлогом, например: +в кафе):",
            "Что они там обнаружили? (Введите в винительном падеже, например: +интересную книгу):",
            "Какое препятствие встретили? (Введите в именительном падеже, например: +сложная ситуация):",
            "Как справились с ситуацией? (Введите в прошедшем времени, например: +нашли общий язык):",
            "Кто помог героям? (Введите в именительном падеже, например: +случайный прохожий):",
            "Что важное приобрели? (Введите в винительном падеже, например: +новый опыт):",
            "Какое открытие сделали? (Введите в винительном падеже, например: +важный урок):",
            "Чем всё закончилось? (Введите полным предложением, например: +Герои стали хорошими друзьями):",
            "Что помогло в пути? (Введите в именительном падеже, например: +карта местности):",
            "Какой навык пригодился? (Введите в именительном падеже, например: +знание языков):",
            "Какую трудность преодолели? (Введите в винительном падеже, например: +языковой барьер):",
            "Какую пользу получили? (Введите в винительном падеже, например: +ценный совет):",
            "Какой вывод сделали? (Введите полным предложением, например: +Поняли важность взаимопомощи):"
        ]
        self.answers = {}
        self.story_templates = [
            "Однажды {2} {1} жил-был {0}. Стояла {3}, создавая идеальную атмосферу для начала истории.\n\nВсё началось с того, что {4}. Это событие изменило привычный уклад жизни и открыло новую страницу. У героя была с собой необычная вещь – {15}, что очень пригодилось позже.\n\nВ начале пути герой встретил {5}. Эта встреча оказалась очень важной для дальнейших событий. Герою пригодился уникальный навык {16}, что помогло лучше понять ситуацию.\n\nПосле этой встречи {0} {6}. Каждое решение приближало к намеченной цели. По пути героям пришлось преодолеть {17}, что сделало их сильнее.\n\nИх путь привёл их {7}, где они неожиданно обнаружили {8}. Это открытие заставило посмотреть на всё другими глазами.\n\nНо возникло препятствие – {9}. Казалось, что ситуация безвыходная, но герои {10}. За проявленную находчивость они получили {18}, что оказалось очень полезным.\n\nВ нужный момент появился {11}, чья помощь оказалась неоценимой. Вместе они приобрели {12}, что открыло новые возможности.\n\nБлагодаря этому они поняли {13}. Всё начало складываться в единую картину. {19}, и это стало важным этапом развития.\n\n{14}\n\n*Эта история учит нас тому, что каждая встреча и каждое событие могут изменить нашу жизнь. Главное – быть открытым новому опыту и не бояться трудностей на своём пути.*",

            "Однажды {2} {1} началась эта необычная история. Главным героем стал {0}, которому предстояло пережить интересные события. При себе у него был необычный предмет – {15}, который сыграл важную роль.\n\nСтояла {3}, что создавало особое настроение. В этот день {4}, что послужило началом целой череды событий. Отточенный навык – {16} – помог лучше разобраться в происходящем.\n\nВ ходе событий герой встретил {5}, что оказалось важным поворотным моментом. Вместе они столкнулись со сложным препятствием – {17}, но смогли найти решение.\n\nПосле этого {0} {6}. Каждый новый шаг приносил героям новые открытия, а {18} стал наградой за настойчивость.\n\nПуть привёл их {7}, где они обнаружили {8}. Это заставило взглянуть на ситуацию по-новому.\n\nНеожиданно возникло препятствие – {9}. В этой ситуации герои {10}. {19}, что стало важным уроком для всех.\n\nСвоевременно {11} предложил помощь. Благодаря совместным усилиям они получили {12}, что оказалось очень кстати.\n\nЭто привело к важному открытию – {13}. Все детали сложились в единую картину, помогая понять суть происходящего.\n\n{14}\n\n*Эта история показывает, как важно быть внимательным к деталям и открытым к новым возможностям. Иногда самые обычные ситуации могут привести к удивительным результатам.*"
        ]
        
    @commands.slash_command()
    async def history(self, inter: disnake.ApplicationCommandInteraction):
        """Создает интерактивную историю на основе ваших ответов"""
        self.answers[inter.channel.id] = []
        
        await inter.response.send_message("Давайте создадим историю вместе! Я задам несколько вопросов. Отвечайте на вопросы, начиная ответ со знака '+'")
        
        for question in self.questions:
            message = await inter.channel.send(question)
            
            while True:
                try:
                    response = await self.bot.wait_for(
                        "message",
                        timeout=300.0,
                        check=lambda m: m.channel == inter.channel
                    )
                    
                    if response.content.startswith("+"):
                        answer = response.content[1:].strip()
                        self.answers[inter.channel.id].append(answer)
                        await response.add_reaction("✅")
                        break
                    else:
                        await response.add_reaction("❌")
                        await inter.channel.send("Ответ должен начинаться со знака '+'. Попробуйте ещё раз.")
                        
                except TimeoutError:
                    await inter.channel.send("Время ожидания истекло. Попробуйте начать заново.")
                    return
                
        story_template = random.choice(self.story_templates)
        answers = self.answers[inter.channel.id]
        
        story = story_template.format(*answers)
        
        embed = disnake.Embed(
            title="✨ Ваша уникальная история ✨",
            description=story,
            color=disnake.Color.gold()
        )
        embed.set_footer(text="Создано с помощью силы воображения ✨")
        await inter.channel.send(embed=embed)
        del self.answers[inter.channel.id]

def setup(bot):
    bot.add_cog(History(bot))
